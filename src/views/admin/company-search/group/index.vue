<template>
  <div class="app-container">
    
    <el-date-picker
      v-model="month"
      type="month"
      placeholder="選擇月份"
      style="width:160px"
      value-format="yyyy-MM">
    </el-date-picker>
    <el-input v-model="company" style="width:250px" placeholder="請輸入廠商"></el-input>
    <el-button type="primary" @click="search">搜尋</el-button>

    <div class ="el-col-24">
      <el-table v-loading="listLoading" :data="itemData" style="width: 100%" :row-class-name="tableRowClassName" empty-text="沒有資料">

        <el-table-column type="index" label="筆數" width='75%' fixed></el-table-column>
        <el-table-column prop="number" label="團號" width='140%' sortable :sort-method = "(a,b)=>{return a.number - b.number}"></el-table-column>
        <el-table-column prop="cs" label="客服" width='75%'></el-table-column>
        <el-table-column prop="depDate" label="出發日期" width='120%' sortable :sort-method = "(a,b) =>a.depDate.localeCompare(b.depDate)"></el-table-column>
        <el-table-column prop="endDate" label="結束日期" width='120%' sortable :sort-method = "(a,b) =>a.endDate.localeCompare(b.endDate)"></el-table-column>
        <el-table-column prop="name" label="團名"  sortable :sort-method = "(a,b)=>a.name.localeCompare(b.name)"></el-table-column>
        <el-table-column prop="company" label="公司名稱"  sortable :sort-method = "(a,b)=>a.company.localeCompare(b.company)"></el-table-column>
        <el-table-column prop="people" label="代表人" sortable :sort-method = "(a,b)=>a.people.localeCompare(b.people)"></el-table-column>
        <el-table-column prop="payDetailCompany" label="廠商" ></el-table-column>
        <el-table-column prop="item" label="品項" sortable :sort-method = "(a,b)=>{return a.phone - b.phone}"></el-table-column>
        <el-table-column prop="pay" label="支出" width='80%'></el-table-column>
        <el-table-column prop="dl1" label="第一筆DL" width='120%' ></el-table-column>
        <el-table-column prop="dlpay1" label="第一筆金額" width='120%' ></el-table-column>
        <el-table-column prop="dl2" label="第二筆DL" width='120%' ></el-table-column>
        <el-table-column prop="dlpay2" label="第二筆金額" width='120%' ></el-table-column>
        <el-table-column prop="" label="編輯" width='60%'>
          <template slot-scope="scope">
            <el-button @click="edit(scope.row)" type="text" >編輯</el-button>
          </template>
        </el-table-column>
        
      </el-table>
      <el-row>
        <span class="font el-col-4 el-col-sm-12 el-col-xs-12 el-col-xl-4 el-col-lg-4"><font color="black">總支出：{{payTotal}}</font></span>
      </el-row>
    </div>
  </div>
</template>

<script>

import { db } from '@/db.js'
import { firebaseApp } from '@/db.js'
import '@/styles/common.css'
import * as moment from "moment/moment";


export default {
  components: {
    
  },
  
  data() {
    return {
      listLoading: false,
      itemData:[],
      month:'',
      company:'',
      payTotal:0,
    }
  },
  created() {
    
  },
  methods: {
    tableRowClassName({row, rowIndex}) {
      if (rowIndex%2 === 1) {
        return 'color-row';
      }
      return '';
    },
    search() {
      this.listLoading = true
      let i = 0
      let ref = db.collection(this.month+'G');
      let priceInsufficient = 0
      // payDetailCompany

      ref.where('payDetailCompany','array-contains',this.company).onSnapshot((querySnapshot => { //資料編排改變後 客服需改變
        this.itemData.length = 0
        this.payTotal = 0
        querySnapshot.forEach(doc => {  

          for(let j=0;j<doc.data().payDetailCompany.length;j++){
            if(doc.data().payDetailCompany[j] == this.company){
              this.itemData.push({
                ...doc.data(),
                'payDetailCompany':doc.data().payDetailCompany[j],
                'item':doc.data().payDetailItem[j],
                'pay':doc.data().payDetailPay[j],
                'dl1':doc.data().payDetailDl1[j],
                'dlpay1':doc.data().payDetailDlPay1[j],
                'dl2':doc.data().payDetailDl2[j],
                'dlpay2':doc.data().payDetailDlPay2[j],
              })
              this.payTotal = parseInt(doc.data().payDetailPay[j]) + this.payTotal
            }
          }
          // console.log(doc.data().number)
        }); 
        this.itemData.reverse()
        this.itemData.reverse() 
      }));
      
      
      this.listLoading = false
    },
    edit(row){
      console.log(row)

      let route = this.$router.resolve({
        path: '/admin/edit/group',
        query: { number:row.number,depDate:moment(row.depDate).format('YYYY-MM') }
      })
      window.open(route.href, '_blank');
    }
  },
  mounted(){
    
  }
}
</script>



